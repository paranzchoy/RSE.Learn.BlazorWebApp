@inherits LayoutComponentBase
@using MudBlazor

<!-- GrapesJS CSS -->
<link rel="stylesheet" href="https://unpkg.com/grapesjs@0.21.7/dist/css/grapes.min.css">
<link href="css/grapes-editor.css" rel="stylesheet" />

<!-- Required MudBlazor resources -->
<MudThemeProvider />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<div class="grapesjs-layout">
    @Body
</div>

<!-- GrapesJS and its plugins -->
<script src="https://unpkg.com/grapesjs@0.21.7"></script>
<script>
    // Global editor instance
    let editor = null;

    // Initialize the GrapesJS editor
    window.initGrapesEditor = function (elementId, html, css) {
        console.log('Initializing GrapesJS editor with:', { elementId, html, css });
        
        // Clear any existing editor
        if (editor) {
            editor.destroy();
            editor = null;
        }
        
        // Create the editor
        editor = grapesjs.init({
            container: `#${elementId}`,
            height: '700px',
            width: 'auto',
            storageManager: false,
            panels: { defaults: [] },
            deviceManager: {
                devices: [
                    { name: 'Desktop', width: '' },
                    { name: 'Tablet', width: '768px' },
                    { name: 'Mobile', width: '320px' }
                ]
            },
            blockManager: {
                appendTo: '#blocks',
                blocks: [
                    {
                        id: 'section',
                        label: 'Section',
                        attributes: { class: 'gjs-block-section' },
                        content: '<section><h1>This is a section title</h1><div>This is section content</div></section>',
                    },
                    {
                        id: 'text',
                        label: 'Text',
                        content: '<div data-gjs-type="text">Insert your text here</div>',
                    },
                    {
                        id: 'image',
                        label: 'Image',
                        content: { type: 'image' },
                    }
                ]
            }
        });

        // Load the content
        if (html && html.trim()) {
            editor.setComponents(html);
        }
        
        if (css && css.trim()) {
            editor.setStyle(css);
        }
        
        console.log('GrapesJS editor initialized successfully');
        return true;
    };

    // Get the HTML content
    window.getEditorHtml = function() {
        return editor ? editor.getHtml() : '';
    };

    // Get the CSS content
    window.getEditorCss = function() {
        return editor ? editor.getCss() : '';
    };
</script>

<div id="blazor-error-ui" data-nosnippet>
    An unhandled error has occurred.
    <a href="." class="reload">Reload</a>
    <span class="dismiss">ðŸ—™</span>
</div>

<style>
    .grapesjs-layout {
        width: 100%;
        height: 100vh;
        margin: 0;
        padding: 0;
        overflow: hidden;
    }
    
    .editor-container {
        display: flex;
        flex-direction: row;
        height: 90vh;
        position: relative;
    }
    
    #blocks {
        width: 200px;
        padding: 10px;
        background-color: #f5f5f5;
        border-right: 1px solid #ddd;
        overflow-y: auto;
    }
    
    #gjs {
        flex: 1;
        height: 100%;
    }
    
    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(255, 255, 255, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }
    
    .control-panel {
        position: fixed;
        bottom: 0;
        left: 200px;
        right: 0;
        background: #f5f5f5;
        padding: 10px;
        border-top: 1px solid #ddd;
        z-index: 100;
    }
    
    .debug-info {
        max-height: 200px;
        overflow-y: auto;
        font-size: 12px;
        background: #fff;
        border: 1px solid #ddd;
        padding: 5px;
    }
</style>